<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/lib/punctuation/double-quotes.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../prettify.css" />
    <link rel="stylesheet" href="../../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../../index.html">All files</a> / <a href="index.html">src/lib/punctuation</a> double-quotes.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>42/42</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/0</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>1/1</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>42/42</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">101x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/*
	Corrects improper use of double quotes and double primes
&nbsp;
	Assumptions and Limitations
	This function assumes that double quotes are always used in pair,
	i.e. authors did not forget to close double quotes in their text.
&nbsp;
	Algorithm
	[0] Remove extra terminal punctuation around double quotes
	[1] Swap right double quote adepts with a terminal punctuation
	    (this comes first as it is a quite common mistake that may eventually
		  lead to improper identification of double primes)
	[2] Identify inches, arcseconds, seconds
	[3] Identify closed double quotes
	[4] Identify the rest as unclosed double quotes (best-effort replacement)
	[5] Reconsider wrongly identified left quote and prime
	[6] Fix spacing around quotes and primes
	[7] Swap back some of the double quotes with a punctuation
	[8] Remove extra comma after punctuation in direct speech
	[9] Add spaces around quotes where missing
	[10] Replace all identified punctuation with appropriate punctuation in
	    given language
&nbsp;
	@param {string} string — input text for identification
	@param {string} language — language option
	@returns {string} output with properly replaces double qoutes and double primes
*/
export function fixDoubleQuotesAndPrimes (string, locale) {
	/* [0] Remove extra terminal punctuation around double quotes
					 e.g. “We will continue tomorrow.”. */
  let pattern = '([' + locale.sentencePunctuation + '])(' + locale.doubleQuoteAdepts + ')([' + locale.sentencePunctuation + '])'
  let re = new RegExp(pattern, 'g')
  string = string.replace(re, '$1$2')
&nbsp;
	/* [1] Swap right double quote adepts with a terminal punctuation */
  pattern = '(' + locale.doubleQuoteAdepts + ')([' + locale.terminalPunctuation + '])'
  re = new RegExp(pattern, 'g')
  string = string.replace(re, '$2$1')
&nbsp;
	/* [2] Identify inches, arcseconds, seconds
				 Note: we’re not using locale.doubleQuoteAdepts variable
				 as commas and low-positioned quotes are ommited */
  pattern = '(\\d[' + locale.spaces + "]?)(“|”|\"|″|‘{2,}|’{2,}|'{2,}|′{2,})",
	re = new RegExp(pattern, 'g')
  string = string.replace(re, '$1{{typopo__double-prime}}')
&nbsp;
	/* [3] Identify closed double quotes */
  pattern = '(' + locale.doubleQuoteAdepts + ')(.*?)(' + locale.doubleQuoteAdepts + ')'
  re = new RegExp(pattern, 'g')
  string = string.replace(re, '{{typopo__left-double-quote}}$2{{typopo__right-double-quote}}')
&nbsp;
	/* [4.1] Identify unclosed left double quotes */
  pattern = '(' + locale.doubleQuoteAdepts + ')([' + locale.lowercaseChars + locale.uppercaseChars + '])'
  re = new RegExp(pattern, 'g')
  string = string.replace(re, '{{typopo__left-double-quote--unclosed}}$2')
&nbsp;
	/* [4.2] Identify unclosed right double quote */
  pattern = '([' + locale.lowercaseChars + locale.uppercaseChars + locale.sentencePunctuation + locale.ellipsis + '])(' + locale.doubleQuoteAdepts + ')'
  re = new RegExp(pattern, 'g')
  string = string.replace(re, '$1{{typopo__right-double-quote--unclosed}}')
&nbsp;
	/* [4.3] Remove remaining unidentified double quote */
  pattern = '([' + locale.spaces + '])(' + locale.doubleQuoteAdepts + ')([' + locale.spaces + '])'
  re = new RegExp(pattern, 'g')
  string = string.replace(re, '$1$3')
&nbsp;
	/* [5] Reconsider wrongly identified left quote and prime
&nbsp;
		 Take following example:
		 It’s called “Localhost 3000” and it’s pretty fast.
&nbsp;
		 So far, our algorithm falsely identifies prime folowing the number
		 and unclosed left double quote.
		 We'll find that identifications and swap it back to double quote pair.
	*/
  pattern = '({{typopo__left-double-quote--unclosed}})(.*?)({{typopo__double-prime}})'
  re = new RegExp(pattern, 'g')
  string = string.replace(re, '{{typopo__left-double-quote}}$2{{typopo__right-double-quote}}')
&nbsp;
	/* [6] Remove extra spaces around quotes and prime */
  string = string.replace(/({{typopo__left-double-quote}})( )/g, '$1')
  string = string.replace(/( )({{typopo__right-double-quote}})/g, '$2')
  string = string.replace(/( )({{typopo__double-prime}})/g, '$2')
&nbsp;
	/* [7] Swap back some of the double quotes with a punctuation
&nbsp;
		 Idea
		 In [1] we have swapped all double right quotes by default with a terminal
		 punctuation. However, not all double quotes wrap the whole sentence and
		 there are cases when few words are quoted within a sentence. Take a look at
		 examples:
		 “Sentence qouted as a whole.” (full stop is placed within double quotes)
		 This is “quoted expression.” (full stop is placed outside double quotes)
&nbsp;
		 Algorithm
		 Match all the double quote pairs that do not precede sentence punctuation
		 (and thus must be used within a sentence) and swap right double with
		 a terminal punctuation.
		 */
  pattern = '([^' + locale.sentencePunctuation + '][' + locale.spaces + ']{{typopo__left-double-quote}}.+?)([' + locale.terminalPunctuation + '])({{typopo__right-double-quote}})'
  re = new RegExp(pattern, 'g')
  string = string.replace(re, '$1$3$2')
&nbsp;
	/* [8]	Remove extra comma after punctuation in direct speech,
					 e.g. "“Hey!,” she said"
&nbsp;
					Sidenote
					(?![\.]) is negative lookahead to exlude period from
					sentencePunctuation set, see related test case
					 */
  pattern = '(?![\.])([' + locale.sentencePunctuation + '])([\,])'
  re = new RegExp(pattern, 'g')
  string = string.replace(re, '$1')
&nbsp;
	/* [9.1] Add extra space before left quote, if it’s following word or sentence punctuation */
  pattern = '([' + locale.sentencePunctuation + locale.allChars + '])({{typopo__left-double-quote}})'
  re = new RegExp(pattern, 'g')
  string = string.replace(re, '$1 $2')
&nbsp;
	/* [9.2] Add extra space after right quote if it’s preceding a word */
  pattern = '({{typopo__right-double-quote}})([' + locale.allChars + '])'
  re = new RegExp(pattern, 'g')
  string = string.replace(re, '$1 $2')
&nbsp;
	/* [10] Replace all identified punctuation with appropriate punctuation in
	    given language */
  string = string.replace(/({{typopo__double-prime}})/g, locale.doublePrime)
  string = string.replace(/({{typopo__left-double-quote}}|{{typopo__left-double-quote--unclosed}})/g, locale.leftDoubleQuote)
  string = string.replace(/({{typopo__right-double-quote}}|{{typopo__right-double-quote--unclosed}})/g, locale.rightDoubleQuote)
&nbsp;
  return string
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Mon Jul 17 2017 13:31:58 GMT+0200 (CEST)
</div>
</div>
<script src="../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../sorter.js"></script>
</body>
</html>
